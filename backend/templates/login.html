<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Mi Catálogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-blue-500 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-sm">
        <!--Encabezado-->
        <div class="text-center mb-6">
            <i class="fas fa-film text-blue-500 text-4xl mb-2"></i>
            <h1 class="text-xl font-bold text-gray-800">Mi Catálogo</h1>
            <p class="text-gray-600 text-sm">Tus películas favoritas</p>
        </div>

        <!--Correoycontra-->
        <form id="formulario-login" class="space-y-4">
            <div>
                <input type="email" id="correo" required
                       class="w-full p-3 border border-gray-300 rounded"
                       placeholder="Tu correo electrónico">
            </div>

            <div>
                <input type="password" id="contraseña" required
                       class="w-full p-3 border border-gray-300 rounded"
                       placeholder="Tu contraseña">
            </div>

            <!--Olvida contraseña-->
            <div class="text-right">
                <button type="button" id="boton-olvide" class="text-blue-600 text-sm hover:underline">
                    ¿Olvidaste tu contraseña?
                </button>
            </div>

            <!--Mensajes-->
            <div id="mensaje-error" class="hidden bg-red-100 text-red-700 p-2 rounded text-sm"></div>
            <div id="mensaje-exito" class="hidden bg-green-100 text-green-700 p-2 rounded text-sm"></div>

            <!--Botones-->
            <div class="space-y-3">
                <button type="submit" id="boton-entrar" 
                        class="w-full bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700">
                    <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                </button>
                
                <button type="button" id="boton-registrar" 
                        class="w-full bg-green-600 text-white p-3 rounded font-semibold hover:bg-green-700">
                    <i class="fas fa-user-plus mr-2"></i>Crear Cuenta
                </button>
            </div>
        </form>

        
        <div id="cargando" class="hidden text-center mt-4">
            <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            <p class="text-gray-600 text-sm mt-1">Cargando...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            sendPasswordResetEmail 
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Configuración Firebase
        const configuracionFirebase = {
            apiKey: "AIzaSyAV2CxG_nc2F-pdiQ2CiCEmBXUneH5RibE",
            authDomain: "movie-catalogo.firebaseapp.com",
            projectId: "movie-catalogo",
            storageBucket: "movie-catalogo.firebasestorage.app",
            messagingSenderId: "1022078354140",
            appId: "1:1022078354140:web:487f91b170d16eecbb2a19"
        };

        const app = initializeApp(configuracionFirebase);
        const autenticacion = getAuth(app);

        class AplicacionLogin {
            constructor() {
                this.iniciar();
            }

            iniciar() {
                document.getElementById('formulario-login').addEventListener('submit', (e) => this.entrar(e));
                document.getElementById('boton-registrar').addEventListener('click', () => this.registrar());
                document.getElementById('boton-olvide').addEventListener('click', () => this.olvideContraseña());
                
                // Verificar si ya está logueado
                onAuthStateChanged(autenticacion, (usuario) => {
                    if (usuario) this.manejarExito(usuario);
                });
            }

            async entrar(e) {
                e.preventDefault();
                this.mostrarCargando(true);

                const correo = document.getElementById('correo').value;
                const contraseña = document.getElementById('contraseña').value;

                try {
                    await signInWithEmailAndPassword(autenticacion, correo, contraseña);
                } catch (error) {
                    this.mostrarError('Error al entrar: ' + error.message);
                    this.mostrarCargando(false);
                }
            }

            async registrar() {
                this.mostrarCargando(true);

                const correo = document.getElementById('correo').value;
                const contraseña = document.getElementById('contraseña').value;

                if (!correo || !contraseña) {
                    this.mostrarError('Completa todos los campos');
                    this.mostrarCargando(false);
                    return;
                }

                if (contraseña.length < 6) {
                    this.mostrarError('La contraseña debe tener al menos 6 letras');
                    this.mostrarCargando(false);
                    return;
                }

                try {
                    const usuario = await createUserWithEmailAndPassword(autenticacion, correo, contraseña);
                    this.mostrarExito('¡Cuenta creada! Entrando...');
                    
                    setTimeout(() => {
                        this.manejarExito(usuario.user);
                    }, 2000);
                    
                } catch (error) {
                    let mensaje = 'Error al crear cuenta';
                    
                    if (error.code === 'auth/email-already-in-use') {
                        mensaje = 'Este correo ya existe. Entrando...';
                        setTimeout(() => {
                            this.entrar(new Event('submit'));
                        }, 1500);
                    } else if (error.code === 'auth/invalid-email') {
                        mensaje = 'El correo no es válido';
                    }
                    
                    this.mostrarError(mensaje);
                    this.mostrarCargando(false);
                }
            }

            async olvideContraseña() {
                const correo = document.getElementById('correo').value;
                
                if (!correo) {
                    this.mostrarError('Escribe tu correo');
                    return;
                }

                this.mostrarCargando(true);

                try {
                    await sendPasswordResetEmail(autenticacion, correo);
                    this.mostrarExito('Te enviamos un correo para recuperar tu contraseña');
                } catch (error) {
                    this.mostrarError('Error: ' + error.message);
                } finally {
                    this.mostrarCargando(false);
                }
            }

            async manejarExito(usuario) {
                try {
                    const token = await usuario.getIdToken();
                    
                    const respuesta = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken: token })
                    });

                    const resultado = await respuesta.json();

                    if (resultado.success) {
                        window.location.href = '/';
                    } else {
                        this.mostrarError('Error del servidor');
                        await autenticacion.signOut();
                        this.mostrarCargando(false);
                    }
                } catch (error) {
                    this.mostrarError('Error de conexión');
                    await autenticacion.signOut();
                    this.mostrarCargando(false);
                }
            }

            mostrarError(mensaje) {
                const div = document.getElementById('mensaje-error');
                div.textContent = mensaje;
                div.classList.remove('hidden');
            }

            mostrarExito(mensaje) {
                const div = document.getElementById('mensaje-exito');
                div.textContent = mensaje;
                div.classList.remove('hidden');
            }

            mostrarCargando(mostrar) {
                const cargando = document.getElementById('cargando');
                const botonEntrar = document.getElementById('boton-entrar');
                const botonRegistrar = document.getElementById('boton-registrar');
                
                if (mostrar) {
                    cargando.classList.remove('hidden');
                    botonEntrar.disabled = true;
                    botonRegistrar.disabled = true;
                } else {
                    cargando.classList.add('hidden');
                    botonEntrar.disabled = false;
                    botonRegistrar.disabled = false;
                }
            }
        }

        new AplicacionLogin();
    </script>
</body>
</html>